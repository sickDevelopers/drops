<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Drops - joypade</title>
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.6.3/css/all.css"
          integrity="sha384-UHRtZLI+pbxtHCWp1t77Bi1L4ZtiqrqD80Kn4Z8NTSRyMA2Fd33n5dQ8lWUE00s/" crossorigin="anonymous">
    <link rel="stylesheet" href="../css/bootstrap4-neon-glow.min.css">
    <script src="https://cdn.auth0.com/js/auth0-spa-js/1.20/auth0-spa-js.production.js"></script>
    <script src="https://unpkg.com/colyseus.js"></script>

    <link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet">
    <link rel='stylesheet' href='//cdn.jsdelivr.net/font-hack/2.020/css/hack.min.css'>

    <style>
        .view {
            display: none;
        }
        .show {
            display: block;
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body>

<div id="app">

    <div id="unauth" class="view">
        <button onclick="Auth.login()">Login</button>
    </div>

    <div id="auth" class="view">
        <button onclick="Auth.logout()">Logout</button>

        <div id="waiting-box" class="view">WAITING FOR OTHER PLAYERS...</div>

        <div id="joypad" class="view">
            <div>
                <p class="slider-box">
                    <label for="military">Military</label>
                    <!--        <button class="lock" data-locks="military">lock</button>-->
                    <input type="range" value="33" class="range-input" id="military" min="0" max="100" step="1">
                    <span id="military-value" class="range-input-value"></span>
                </p>
            </div>
            <div>
                <p class="slider-box">
                    <label for="production">Production</label>
                    <!--        <button class="lock" data-locks="production">lock</button>-->
                    <input type="range" value="34" class="range-input" id="production" min="0" max="100" step="1">
                    <span id="production-value" class="range-input-value"></span>
                </p>
            </div>
            <div>
                <p class="slider-box">
                    <label for="research">Research</label>
                    <!--        <button class="lock" data-locks="research">lock</button>-->
                    <input type="range" value="33" class="range-input" id="research" min="0" max="100" step="1">
                    <span id="research-value" class="range-input-value"></span>
                </p>
            </div>
            <div>
                resources <span id="resources-box"></span>
                | cells <span id="score-box"></span>
                | dev <span id="development-box"></span>
                | lev <span id="milestone-box"></span>
            </div>
        </div>
    </div>
</div>


<script>

    const AUTH_REDIRECT_URI =  window.location.href.slice(0, -1);
    const HOSTNAME = window.location.hostname;

    window.onload = async () => {
        await Auth.configureClient()

        if (Auth.isComingFromRedirect()) {
            await Auth.handleRedirectCallback()
        }

        if (await Auth.isAuthenticated()) {
            UI.showAuth();
        } else {
            UI.showUnauth();
        }

    }



    const Auth = {
        auth0: null,
        configureClient: async () => {
            const response = await Auth.fetchAuthConfig();
            const config = await response.json();
            Auth.auth0 = await createAuth0Client({
                domain: config.domain,
                client_id: config.clientId
            });
        },
        fetchAuthConfig: () => fetch("auth_config.json"),
        login: async () => {
            await Auth.auth0.loginWithRedirect({
                redirect_uri: AUTH_REDIRECT_URI
            });
        },
        logout: () => {
            Auth.auth0.logout({
                returnTo: AUTH_REDIRECT_URI
            });
        },
        isComingFromRedirect: () => {
            const query = window.location.search;
            return query.includes("code=") && query.includes("state=");
        },
        handleRedirectCallback: async () => {
            await Auth.auth0.handleRedirectCallback()
            window.history.replaceState({}, document.title, "/joypad/");
        },
        isAuthenticated: () => {
            return Auth.auth0.isAuthenticated();
        },
        getUser: () => {
            return Auth.auth0.getUser();
        },
        getToken: () => {
            return Auth.auth0.getTokenSilently()
        }
    }

    const UI = {
        // main divs
        unauthDiv: document.getElementById("unauth"),
        authDiv: document.getElementById("auth"),
        // score boxes
        scoreBox: document.getElementById("score-box"),
        resourcesBox: document.getElementById("resources-box"),
        developmentBox: document.getElementById("development-box"),
        milestoneBox: document.getElementById("milestone-box"),
        // waiting box
        waitingBox: document.getElementById("waiting-box"),
        // rangeInputs
        inputs: Array.from(document.getElementsByClassName('range-input')),
        // joypad
        joypad: document.getElementById("joypad"),

        // methods
        showUnauth: () => {
            UI.unauthDiv.classList.add("show");
            UI.authDiv.classList.remove("show");
        },
        showAuth: () => {
            UI.unauthDiv.classList.remove("show");
            UI.authDiv.classList.add("show");
            Game.init();
        },
        showComponent: (component) => {
            component.classList.add("show");
        },
        hideComponent: (component) => {
            component.classList.remove("show");
        },
    }

    const Game = {
        battleRoom: null,
        relayRoom: null,
        startGameLoop: async function (client, user) {

            console.log('Joining relay room...');
            await Game.joinRelayRoom(client, user);

            console.log('Waiting for enough players...');
            await Game.waitForBattleReady();

            console.log('Joining battle room...');
            await Game.joinBattleRoom(client, user);
            
            console.log('Waiting for start battle message...');
            await Game.waitForBattleStart();
            
            console.log("Battle started");

            UI.showComponent(UI.joypad);
            UI.hideComponent(UI.waitingBox);

            Joypad.handleInput();

            Game.handleStateChange(user, client);
        },
        init: async () => {
            const client = new Colyseus.Client(`ws://${HOSTNAME}/server`);
            const user = await Auth.getUser()
            await Game.startGameLoop(client, user);
        },
        joinRelayRoom: async function (client, user) {
            Game.relayRoom = await client.join("relay")
            Game.relayRoom.send("identity", `${user.sub}:${user.name}`)
            console.log("Joined lobby");
        },
        waitForBattleReady: async function () {
            await new Promise((resolve) => {
                Game.relayRoom.onMessage("battle_ready", () => {
                    console.log("Battle ready");
                    Game.relayRoom.leave();
                    resolve();
                });
            })
        },
        waitForBattleStart: async function() {
            await new Promise((resolve) => {
                Game.battleRoom.onMessage("battle_start", () => {
                    resolve();
                });
            })
        },
        clearBattleRoomOnStorage: function () {
            localStorage.removeItem("battle_room_id");
            localStorage.removeItem("battle_session_id");
        },
        werePlayingAGame: function () {
            return Boolean(localStorage.getItem("battle_session_id"));
        },
        saveBattleSessionOnStorage: function () {
            localStorage.setItem(`battle_session`, Game.battleRoom.sessionId);
        },
        joinBattleRoom: async function (client, user) {
            if (Game.werePlayingAGame()) {
                const sessionId = localStorage.getItem("battle_session_id")
                Game.battleRoom = await client.reconnect("battle", sessionId)
            } else {
                this.clearBattleRoomOnStorage();
                Game.battleRoom = await client.join("battle")
            }

            this.saveBattleSessionOnStorage();

            Game.battleRoom.send("identity", `${user.sub}:${user.name}`)

            UI.showComponent(UI.waitingBox);
        },
        handleStateChange: function (user, client) {
            Game.battleRoom.onStateChange(state => {

                field = []
                state.field.cols.forEach((col) => {
                    const column = [];
                    col.col.forEach((cell) => {
                        column.push(cell);
                    });
                    field.push(column);
                });

                let me = [];
                state.players.forEach((player) => {
                    console.log(`player`, player)
                    if (player.sub === user.sub) {
                        me = player;
                    }
                });

                console.log(`me`, me)

                if (me) {
                    UI.resourcesBox.innerText = `${me.resources}`;
                    UI.scoreBox.innerHTML = `${me.score}`;
                    UI.developmentBox.innerHTML = `${me.development}`;
                    UI.milestoneBox.innerHTML = `${me.milestone_reached}`;
                }

            })


            Game.battleRoom.onMessage("endgame", async () => {
                console.log("Battle ended");
                Game.battleRoom.leave();

                UI.hideComponent(UI.joypad);

                Game.startGameLoop();

            });
        },
    }

    const Joypad = {


        handleInput: () => {
            const maxTotal = 100; // define the max sum of values
            const getTotal = function () { // helper function to calculate the sum
                var sum = 0;
                UI.inputs.forEach(function (input) {
                    sum += parseInt(input.value, 10);
                });
                return sum;
            };
            const maxReached = function (e) {  // check if the max is reached
                var sum = getTotal(), target;
                if (sum > maxTotal) {
                    target = e.target;
                    // set the max possible value if the user, for example, clicks too far to the right
                    target.value = target.value - (sum - maxTotal);
                    // next line is just for demonstrational purposes
                    // document.getElementById('total').innerHTML = getTotal();

                    // prevent increasing the value
                    e.preventDefault();
                    return false;
                }
                // next line is just for demonstrational purposes
                // document.getElementById('total').innerHTML = getTotal();

                // everything's fine, nothing to do.
                return true;
            };

            // attach the maxReached function to your inputs
            UI.inputs.forEach(function (input) {
                input.addEventListener('input', maxReached);
            });

            UI.inputs.forEach(function (input) {
                input.addEventListener('change', e => {
                    const toSend = [];

                    UI.inputs.forEach(function (input) {

                        switch (input.id) {
                            case "military":
                                toSend[0] = input.value / 100;
                                break;
                            case "production":
                                toSend[1] = input.value / 100;
                                break;
                            case "research":
                                toSend[2] = input.value / 100;
                                break;
                        }

                    });

                    Game.battleRoom.send('action', toSend.join(','));

                });
            });
        }
    }

</script>
</body>

