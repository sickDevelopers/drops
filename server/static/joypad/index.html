<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Drops - joypad</title>
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.6.3/css/all.css"
          integrity="sha384-UHRtZLI+pbxtHCWp1t77Bi1L4ZtiqrqD80Kn4Z8NTSRyMA2Fd33n5dQ8lWUE00s/" crossorigin="anonymous">
    <link rel="stylesheet" href="../css/bootstrap4-neon-glow.min.css">
    <script src="https://cdn.auth0.com/js/auth0-spa-js/1.20/auth0-spa-js.production.js"></script>
    <script src="./colyseus.js"></script>

    <link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet">

    <style>

        /*@media only screen and (orientation:landscape){*/
        /*    body {*/
        /*        height: 100vw;*/
        /*        transform: rotate(90deg);*/
        /*    }*/
        /*}*/

        .view {
            display: none;
        }

        .show {
            display: block;
        }

        .disconnected {
            color: gray;
        }

        .slider-box {
            padding: 0 10px;
        }

        .slider-box label {
            display: block;
            margin-bottom: 0;
        }

        .slider-box input {
            width: 100%;
        }
        header {
            text-align: right;
        }

        #color {
            display: inline-block;
            width: 30px;
            height: 30px;
            border: none;
        }
    </style>
</head>
<body>

<div id="app">

    <div id="unauth" class="view">
        <button class="btn btn-icon" onclick="Auth.login()">
            Sign in <em class="fa fa-door"></em>
        </button>
    </div>

    <div id="auth" class="view">
        <header>
            <button class="btn btn-icon" onclick="Auth.logout()">
                Logout <em class="fa fa-arrow-right-from-bracket"></em>
            </button>
        </header>

        <div id="intro" class="view">

            <p class="text-center mt-5">

                <h3>Welcome</h3>
                <h2 id="welcome-player-name"></h2>

                <button class="btn btn-secondary" id="enqueue-button">
                    <em class="fa fa-rocket"></em>
                    Join!
                    <em class="fa fa-rocket"></em>
                </button>
            </p>

        </div>

        <div id="waiting-box" class="view">
            WAITING FOR OTHER PLAYERS...
        </div>

        <div id="relay" class="view">
            <ol id="relay-queue-box"></ol>
        </div>

        <div id="joypad" class="view">

            <div class="color-box">
                <p>
                    <span id="color"></span> Your color
                </p>
            </div>

            <div>
                <p class="slider-box">
                    <label for="military">Military</label>
                    <button class="lock" data-locks="military">lock</button>
                    <input type="range" value="33" class="range-input" id="military" min="0" max="100" step="1">
                    <span id="military-value" class="range-input-value"></span>
                </p>
            </div>
            <div>
                <p class="slider-box">
                    <label for="production">Production</label>
                    <button class="lock" data-locks="production">lock</button>
                    <input type="range" value="34" class="range-input" id="production" min="0" max="100" step="1">
                    <span id="production-value" class="range-input-value"></span>
                </p>
            </div>
            <div>
                <p class="slider-box">
                    <label for="research">Research</label>
                    <button class="lock" data-locks="research">lock</button>
                    <input type="range" value="33" class="range-input" id="research" min="0" max="100" step="1">
                    <span id="research-value" class="range-input-value"></span>
                </p>
            </div>
            <div>
                resources <span id="resources-box"></span>
                | cells <span id="score-box"></span>
                | dev <span id="development-box"></span>
                | lev <span id="milestone-box"></span>
            </div>
        </div>
    </div>

    <div id="end-screen" class="view">
        <p>Thank you for playing!</p>
        <a href="/joypad">Play again</a>
    </div>


</div>


<script>

    const url = new URL(window.location.href);

    const HOSTNAME = `${url.protocol}//${url.hostname}${url.port ? `:${url.port}` : ''}`;
    const HOSTNAME_NO_PROTOCOL = `${url.hostname}${url.port ? `:${url.port}` : ''}`;
    const AUTH_REDIRECT_URI = `${HOSTNAME}${url.pathname}`;

    // const MULTIPLAYER_HOST = `ws://localhost:7000`
    const MULTIPLAYER_HOST = `wss://${HOSTNAME_NO_PROTOCOL}/server`

    window.onload = async () => {
        await Auth.configureClient()

        if (Auth.isComingFromRedirect()) {
            await Auth.handleRedirectCallback()
        }

        if (await Auth.isAuthenticated()) {
            UI.showAuth();
        } else {
            UI.showUnauth();
        }

    }


    const Auth = {
        auth0: null,
        configureClient: async () => {
            const response = await Auth.fetchAuthConfig();
            const config = await response.json();
            Auth.auth0 = await createAuth0Client({
                domain: config.domain,
                client_id: config.clientId
            });
        },
        fetchAuthConfig: () => fetch("auth_config.json"),
        login: async () => {
            console.log(`login AUTH_REDIRECT_URI`, AUTH_REDIRECT_URI)
            await Auth.auth0.loginWithRedirect({
                redirect_uri: AUTH_REDIRECT_URI
            });
        },
        logout: () => {
            console.log('logout AUTH_REDIRECT_URI', AUTH_REDIRECT_URI)
            Auth.auth0.logout({
                returnTo: AUTH_REDIRECT_URI
            });
        },
        isComingFromRedirect: () => {
            const query = window.location.search;
            return query.includes("code=") && query.includes("state=");
        },
        handleRedirectCallback: async () => {
            await Auth.auth0.handleRedirectCallback()
            window.history.replaceState({}, document.title, "/joypad/");
        },
        isAuthenticated: () => {
            return Auth.auth0.isAuthenticated();
        },
        getUser: () => {
            return Auth.auth0.getUser();
        },
        getToken: () => {
            return Auth.auth0.getTokenSilently()
        }
    }

    const UI = {
        // main divs
        unauthDiv: document.getElementById("unauth"),
        authDiv: document.getElementById("auth"),
        // intro
        introDiv: document.getElementById("intro"),
        // score boxes
        scoreBox: document.getElementById("score-box"),
        resourcesBox: document.getElementById("resources-box"),
        developmentBox: document.getElementById("development-box"),
        milestoneBox: document.getElementById("milestone-box"),
        // waiting box
        waitingBox: document.getElementById("waiting-box"),
        // rangeInputs
        inputs: Array.from(document.getElementsByClassName('range-input')),
        // joypad
        joypad: document.getElementById("joypad"),
        // locks
        lockButtons: Array.from(document.getElementsByClassName('lock')),
        // relay queue
        relayQueue: document.getElementById("relay"),
        endScreen: document.getElementById("end-screen"),
        enqueueButton: document.getElementById("enqueue-button"),

        colorBox: document.getElementById("color"),
        welcomePlayerName: document.getElementById("welcome-player-name"),

        // methods
        showUnauth: () => {
            UI.hideComponent(UI.authDiv)
            UI.showComponent(UI.unauthDiv);
        },
        showAuth: () => {
            UI.hideComponent(UI.unauthDiv)
            UI.showComponent(UI.authDiv);
            UI.showComponent(UI.introDiv);

            Auth.getUser().then(user => {
                UI.welcomePlayerName.innerText = user.name;
            })

            UI.enqueueButton.addEventListener("click", e => {
                e.preventDefault();
                UI.hideComponent(UI.introDiv);
                Game.init();
            });

        },
        showEnding: () => {
            UI.hideComponent(UI.authDiv)
            UI.hideComponent(UI.unauthDiv);
            UI.showComponent(UI.endScreen);
        },
        showComponent: (component) => {
            component.classList.add("show");
        },
        hideComponent: (component) => {
            component.classList.remove("show");
        },
        updateRelayQueue: () => {
            const queue = Game.relayQueue;
            console.log(`queue`, queue)
            UI.relayQueue.innerHTML = '';
            for (let i = 0; i < queue.length; i++) {
                const item = queue[i];
                const name = item.split('|')[0];
                const connected = item.split('|')[1] === "true";
                const li = document.createElement('li');
                if (!connected) {
                    li.classList.add('disconnected')
                }
                li.innerText = name;
                UI.relayQueue.appendChild(li);
            }
        },

    }

    const Game = {
        battleRoom: null,
        relayRoom: null,
        relayQueue: [],
        init: async () => {
            const client = new Colyseus.Client(MULTIPLAYER_HOST);
            const user = await Auth.getUser()

            UI.showComponent(UI.relayQueue);

            await Game.startGameLoop(client, user);
        },
        startGameLoop: async function (client, user) {

            try {
                console.log('Joining relay room...');
                await Game.joinRelayRoom(client, user);

                console.log('Waiting for enough players...');
                await Game.waitForBattleReady();

                console.log('Joining battle room...');
                await Game.joinBattleRoom(client, user);

                console.log('Waiting for start battle message...');
                await Game.waitForBattleStart();

                console.log("Battle started");

                UI.showComponent(UI.joypad);
                UI.hideComponent(UI.waitingBox);
                UI.hideComponent(UI.relayQueue);

                Joypad.handleInput();

                Game.handleStateChange(user, client);
            } catch (err) {
                alert(err);
                window.location.reload();
            }

        },
        joinRelayRoom: async function (client, user) {
            Game.relayRoom = await client.join("relay")
            await new Promise(resolve => {
                setTimeout(() => {
                    console.log('sending identity');
                    Game.relayRoom.send("identity", `${user.sub}:${user.name}`)
                    console.log("Joined lobby");
                    resolve();
                }, 1000);
            })

        },
        waitForBattleReady: async function () {
            await new Promise((resolve) => {

                Game.relayRoom.onMessage("queue", (queue) => {
                    Game.relayQueue = queue;
                    UI.updateRelayQueue();
                })

                Game.relayRoom.onMessage("battle_ready", () => {
                    console.log("Battle ready");
                    Game.relayRoom.leave();
                    resolve();
                });
            })
        },
        waitForBattleStart: async function () {
            await new Promise((resolve) => {
                Game.battleRoom.onMessage("battle_start", () => {
                    resolve();
                });
            })
        },
        clearBattleRoomOnStorage: function () {
            localStorage.removeItem("battle_room_id");
            localStorage.removeItem("battle_session_id");
        },
        werePlayingAGame: function () {
            return Boolean(localStorage.getItem("battle_session_id"));
        },
        saveBattleSessionOnStorage: function () {
            localStorage.setItem(`battle_session`, Game.battleRoom.sessionId);
        },
        joinBattleRoom: async function (client, user) {
            if (Game.werePlayingAGame()) {
                const sessionId = localStorage.getItem("battle_session_id")
                Game.battleRoom = await client.reconnect("battle", sessionId)
            } else {
                this.clearBattleRoomOnStorage();
                Game.battleRoom = await client.join("battle")
            }

            this.saveBattleSessionOnStorage();

            Game.battleRoom.send("identity", `${user.sub}:${user.name}`)

            UI.showComponent(UI.waitingBox);
        },
        handleStateChange: function (user, client) {
            Game.battleRoom.onStateChange(state => {

                console.log(`state`, state)

                field = []
                state.field.cols.forEach((col) => {
                    const column = [];
                    col.col.forEach((cell) => {
                        column.push(cell);
                    });
                    field.push(column);
                });

                let me = [];
                state.players.forEach((player) => {
                    if (player.sub === user.sub) {
                        me = player;
                    }
                });

                if (me) {

                    console.log(`me.color`, me.color)
                    UI.colorBox.style.backgroundColor = me.color;

                    UI.resourcesBox.innerText = `${me.resources || 0}`;
                    UI.scoreBox.innerHTML = `${me.score || 0}`;
                    UI.developmentBox.innerHTML = `${me.development || 0}`;
                    UI.milestoneBox.innerHTML = `${me.milestones_reached || 0}`;
                }

            })


            Game.battleRoom.onMessage("endgame", async () => {
                console.log("Battle ended");
                Game.battleRoom.leave();

                UI.hideComponent(UI.joypad);

                // Game.startGameLoop(client, user);

                UI.showEnding();

            });
        },
    }

    const Joypad = {


        handleInput: () => {

            const maxTotal = 100;

            const getTotal = function () {
                var sum = 0;
                UI.inputs.forEach(function (input) {
                    sum += parseInt(input.value, 10);
                });
                return sum;
            };

            UI.inputs.forEach(function (input) {
                input.addEventListener('input', function (e) {

                    const value = parseInt(input.value, 10);
                    const sum = getTotal();
                    const blocked = UI.inputs.filter(i => i.getAttribute('disabled')).length

                    if (sum > maxTotal || sum < maxTotal) {
                        UI.inputs.forEach(otherInput => {
                            if (input.id === otherInput.id) return;
                            if (otherInput.getAttribute('disabled')) return;
                            otherInput.value = otherInput.value - ((sum - maxTotal) / (2 - blocked))
                        })
                        input.value = value - (sum - maxTotal);
                        e.preventDefault();
                        return false;
                    }

                    return true;
                });
            });

            UI.inputs.forEach(function (input) {
                input.addEventListener('change', e => {

                    const toSend = [];

                    UI.inputs.forEach(function (input) {

                        switch (input.id) {
                            case "military":
                                toSend[0] = input.value / 100;
                                break;
                            case "production":
                                toSend[1] = input.value / 100;
                                break;
                            case "research":
                                toSend[2] = input.value / 100;
                                break;
                        }

                    });

                    Game.battleRoom.send('action', toSend.join(','));

                });
            });

            UI.lockButtons.forEach(button => {
                button.addEventListener('click', event => {
                    const forInput = button.getAttribute('data-locks');

                    const input = document.getElementById(forInput)
                    console.log(input.getAttribute('disabled'))
                    if (input.getAttribute('disabled') === null) {
                        input.setAttribute('disabled', "true");
                    } else {
                        input.removeAttribute('disabled')
                    }

                })
            })
        }
    }

</script>
</body>

