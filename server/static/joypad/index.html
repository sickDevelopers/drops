<script src="https://cdn.auth0.com/js/auth0-spa-js/1.20/auth0-spa-js.production.js"></script>
<script src="colyseus.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.1/p5.min.js"></script>
<style>
    * {
        margin: 0;
        padding: 0;
    }

    #joypad-box {
        display: none;
    }

    #waiting-box {
        display: none;
    }

    .slider-box label {
        display: inline-block;
        width: 100px;
    }

    .slider-box .lock {
        display: inline-block;
        width: 100px;
    }

    .hidden {
        display: none;
    }

    #board-box {
        display: none;
    }
</style>

<p>Drops Joypad</p>

<button id="btn-login" disabled="true" onclick="login()">Log in</button>
<button id="btn-logout" disabled="true" onclick="logout()">Log out</button>

<div id="waiting-box">
    <p>Waiting for players to join...</p>
</div>


<div id="joypad-box">
    <div>
        <p class="slider-box">
            <label for="military">Military</label>
            <!--        <button class="lock" data-locks="military">lock</button>-->
            <input type="range" value="33" class="range-input" id="military" min="0" max="100" step="1">
            <span id="military-value" class="range-input-value"></span>
        </p>
    </div>
    <div>
        <p class="slider-box">
            <label for="production">Production</label>
            <!--        <button class="lock" data-locks="production">lock</button>-->
            <input type="range" value="34" class="range-input" id="production" min="0" max="100" step="1">
            <span id="production-value" class="range-input-value"></span>
        </p>
    </div>
    <div>
        <p class="slider-box">
            <label for="research">Research</label>
            <!--        <button class="lock" data-locks="research">lock</button>-->
            <input type="range" value="33" class="range-input" id="research" min="0" max="100" step="1">
            <span id="research-value" class="range-input-value"></span>
        </p>
    </div>
    <div>
        resources <span id="resources-box"></span>
        | cells <span id="score-box"></span>
        | dev <span id="development-box"></span>
        | lev <span id="milestone-box"></span>
    </div>
</div>

<div id="board-box"></div>

<script>

    let field = [
        [0, 0, 0, 0, 0],
        [0, 1, 0, 0, 0],
        [0, 0, 1, 0, 0],
        [0, 0, 0, 0, 0],
        [0, 0, 2, 0, 0],
        [0, 2, 2, 0, 0],
    ];
    let auth0 = null;
    const fetchAuthConfig = () => fetch("/auth_config.json");

    const configureClient = async () => {
        const response = await fetchAuthConfig();
        const config = await response.json();

        auth0 = await createAuth0Client({
            domain: config.domain,
            client_id: config.clientId
        });
    };

    // NEW
    const updateUI = async () => {
        const isAuthenticated = await auth0.isAuthenticated();

        document.getElementById("btn-logout").disabled = !isAuthenticated;
        document.getElementById("btn-login").disabled = isAuthenticated;
    };

    const login = async () => {
        await auth0.loginWithRedirect({
            redirect_uri: window.location.origin
        });
    };

    window.onload = async () => {
        await configureClient();

        // NEW - update the UI state
        updateUI();

        const isAuthenticated = await auth0.isAuthenticated();

        if (isAuthenticated) {
            // show the gated content
            initJoypad();
            return;
        }

        // NEW - check for the code and state parameters
        const query = window.location.search;
        if (query.includes("code=") && query.includes("state=")) {

            // Process the login state
            await auth0.handleRedirectCallback();

            updateUI();

            initJoypad();

            // Use replaceState to redirect the user away and remove the querystring parameters
            window.history.replaceState({}, document.title, "/");
        }
    }

    const logout = () => {
        auth0.logout({
            returnTo: window.location.origin
        });
    };

    function showBattleUi() {
        document.getElementById("waiting-box").style.display = "none";
        document.getElementById("joypad-box").style.display = "block";
        document.getElementById("board-box").style.display = "block";
    }

    function showLobbyUi() {
        document.getElementById("waiting-box").style.display = "block";
        document.getElementById("joypad-box").style.display = "none";
    }

    async function initJoypad() {
        const client = new Colyseus.Client('ws://localhost:7000');

        let battleRoom = undefined;
        const token = auth0.getTokenSilently()
        const user = await auth0.getUser()

        console.log(`user`, user)

        let relayRoom = await client.join("relay")
        relayRoom.send("identity", `${user.sub}:${user.name}`)

        console.log("Joined lobby");

        await new Promise((resolve) => {
            relayRoom.onMessage("battle_ready", () => {
                console.log("Battle ready");
                relayRoom.leave();
                resolve();
            });
        })

        if (localStorage.getItem("battle_room_id") === null) {
            battleRoom = await client.join("battle")
        } else {
            const roomId = localStorage.getItem("battle_room_id")
            const sessionId = localStorage.getItem("battle_session_id")
            battleRoom = await client.reconnect(roomId, sessionId)
        }


        localStorage.setItem(`battle_session`, battleRoom.sessionId);
        localStorage.setItem(`battle_room_id`, battleRoom.roomId);

        battleRoom.send("identity", `${user.sub}:${user.name}`)

        document.getElementById("waiting-box").style.display = "block";

        battleRoom.onMessage("battle_start", () => {

            console.log("Battle started");

            showBattleUi();

            battleRoom.onStateChange(state => {

                field = []
                state.field.cols.forEach((col) => {
                    const column = [];
                    col.col.forEach((cell) => {
                        column.push(cell);
                    });
                    field.push(column);
                });

                let me = [];
                state.players.forEach((player) => {
                    if (player.sub === user.sub) {
                        me = player;
                    }
                });

                if (me) {
                    document.getElementById("resources-box").innerHTML = `${me.resources}`;
                    document.getElementById("score-box").innerHTML = `${me.score}`;
                    document.getElementById("development-box").innerHTML = `${me.development}`;
                    document.getElementById("milestone-box").innerHTML = `${me.milestone_reached}`;
                }

            })

        });

        battleRoom.onMessage("endgame", async () => {
            console.log("Battle ended");
            battleRoom.leave();

            showLobbyUi();

            relayRoom = client.join("relay")
                .then(room => {
                    room.send("identity", `${user.sub}:${user.name}`)
                })

        });



        const maxTotal = 100; // define the max sum of values
        const inputs = Array.from(document.getElementsByClassName('range-input')); // refrence to the elements
        const getTotal = function () { // helper function to calculate the sum
            var sum = 0;
            inputs.forEach(function (input) {
                sum += parseInt(input.value, 10);
            });
            return sum;
        };
        const maxReached = function (e) {  // check if the max is reached
            var sum = getTotal(), target;
            if (sum > maxTotal) {
                target = e.target;
                // set the max possible value if the user, for example, clicks too far to the right
                target.value = target.value - (sum - maxTotal);
                // next line is just for demonstrational purposes
                // document.getElementById('total').innerHTML = getTotal();

                // prevent increasing the value
                e.preventDefault();
                return false;
            }
            // next line is just for demonstrational purposes
            // document.getElementById('total').innerHTML = getTotal();

            // everything's fine, nothing to do.
            return true;
        };

        // attach the maxReached function to your inputs
        inputs.forEach(function (input) {
            input.addEventListener('input', maxReached);
        });

        inputs.forEach(function (input) {
            input.addEventListener('change', e => {
                const toSend = [];

                inputs.forEach(function (input) {

                    switch (input.id) {
                        case "military":
                            toSend[0] = input.value / 100;
                            break;
                        case "production":
                            toSend[1] = input.value / 100;
                            break;
                        case "research":
                            toSend[2] = input.value / 100;
                            break;
                    }

                });

                battleRoom.send('action', toSend.join(','));

            });
        });
    }


    //
    //
    //
    // DRAW
    //
    //
    //

    const colors = [
        '#000000',
        '#FF0000',
        '#00FF00',
        '#0000FF',
        '#FFFF00',
        '#FF00FF',
        '#00FFFF',
        '#FFFFFF',
    ];

    function setup() {
        const canvas = createCanvas(200, 200);
        canvas.parent('board-box');
        background(0);
    }

    function draw() {

        const CELL_SIZE = 5;


        background(0);
        field.forEach((column, x) => {
            column.forEach((cell, y) => {
                fill(colors[cell]);
                noStroke();
                rect(x * CELL_SIZE, y * CELL_SIZE, CELL_SIZE, CELL_SIZE);
            });
        });
    }





</script>

